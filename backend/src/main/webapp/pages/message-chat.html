<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>私信对话</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 16px;
            margin-bottom: 8px;
        }
        .bubble-left {
            background-color: #e9ecef;
            align-self: flex-start;
        }
        .bubble-right {
            background-color: #0d6efd;
            color: #fff;
            align-self: flex-end;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="mb-3">私信对话</h1>
    <div class="mb-3">
        <label class="form-label">对话用户ID</label>
        <input class="form-control" id="withUserId" placeholder="输入对方用户ID">
    </div>
    <button class="btn btn-secondary me-2" onclick="loadMessages()">刷新对话</button>
    <button class="btn btn-outline-primary" onclick="markRead()">标记已读</button>

    <div class="border rounded p-3 bg-white my-3 d-flex flex-column" id="messageList" style="min-height: 300px;"></div>

    <div class="input-group">
        <input class="form-control" id="messageContent" placeholder="输入消息">
        <button class="btn btn-primary" onclick="sendMessage()">发送</button>
    </div>
</div>

<script>
const token = localStorage.getItem('token');
const urlParams = new URLSearchParams(window.location.search);
const withUserIdInput = document.getElementById('withUserId');
if (urlParams.get('withUserId')) {
  withUserIdInput.value = urlParams.get('withUserId');
}

function authHeader() {
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

async function loadMessages() {
  const withUserId = withUserIdInput.value.trim();
  if (!withUserId) return;
  const resp = await fetch(`/backend/api/message/list?withUserId=${withUserId}`, { headers: authHeader() });
  const data = await resp.json();
  const list = document.getElementById('messageList');
  list.innerHTML = '';
  (data.data || []).forEach(item => {
    const bubble = document.createElement('div');
    const isMine = item.fromUserId && Number(item.fromUserId) !== Number(withUserId);
    bubble.className = `bubble ${isMine ? 'bubble-right' : 'bubble-left'}`;
    bubble.textContent = item.content;
    list.appendChild(bubble);
  });
}

async function sendMessage() {
  const withUserId = withUserIdInput.value.trim();
  const content = document.getElementById('messageContent').value.trim();
  if (!withUserId || !content) return;
  await fetch('/backend/api/message/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ to_user_id: Number(withUserId), content })
  });
  document.getElementById('messageContent').value = '';
  loadMessages();
}

async function markRead() {
  const withUserId = withUserIdInput.value.trim();
  if (!withUserId) return;
  await fetch('/backend/api/message/read', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ withUserId: Number(withUserId) })
  });
  loadMessages();
}

loadMessages();
</script>
</body>
</html>
