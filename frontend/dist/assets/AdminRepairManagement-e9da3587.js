import{_ as D,o,c as l,a as t,t as a,e as f,v as A,F as v,i as g,f as h,h as _,g as u,n as S}from"./index-1ef266be.js";const N={name:"AdminRepairManagement",data(){return{username:"",role:"",repairs:[],providers:[],residents:[],selectedResidentId:"",searchKeyword:"",statusFilter:"",residentSearchKeyword:"",showEvaluation:!1,currentEvaluation:null,previewImage:"",showRepairDetail:!1,currentRepair:null,refreshInterval:null}},mounted(){this.username=this.getLocalStorageItem("username"),this.role=this.getLocalStorageItem("role"),this.fetchRepairs(),this.fetchProviders(),this.fetchResidents(),this.refreshInterval=setInterval(()=>{this.fetchRepairs()},3e4)},computed:{filteredResidents(){return this.residentSearchKeyword?this.residents.filter(i=>i.realName.toLowerCase().includes(this.residentSearchKeyword.toLowerCase())||i.phone.includes(this.residentSearchKeyword)):[]}},methods:{getLocalStorageItem(i){return typeof localStorage<"u"?localStorage.getItem(i):null},setLocalStorageItem(i,e){typeof localStorage<"u"&&localStorage.setItem(i,e)},selectResident(i){this.selectedResidentId=i.id,this.residentSearchKeyword="",this.fetchRepairs()},fetchRepairs(){const i=localStorage.getItem("token"),e=new URLSearchParams;this.searchKeyword&&e.append("searchKeyword",this.searchKeyword),this.statusFilter&&e.append("status",this.statusFilter),this.selectedResidentId&&e.append("residentId",this.selectedResidentId),fetch(`/api/repair/list?${e.toString()}`,{method:"GET",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}).then(r=>{if(!r.ok)throw new Error("网络请求失败，状态码："+r.status);return r.json()}).then(r=>{if(r.status==="success"){if(this.repairs=r.data,this.showRepairDetail&&this.currentRepair){const c=this.repairs.find(n=>n.id===this.currentRepair.id);c&&this.viewRepairDetail(c)}}else alert("获取报修列表失败："+(r.message||"未知错误"))}).catch(r=>{console.error("获取报修列表失败：",r),alert("获取报修列表失败，请稍后重试")})},fetchProviders(){const i=localStorage.getItem("token");fetch("/api/providers",{method:"GET",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.status==="success"?this.providers=e.data:alert("获取服务商列表失败："+e.message)}).catch(e=>{console.error("获取服务商列表失败：",e),alert("获取服务商列表失败，请稍后重试")})},fetchResidents(){const i=localStorage.getItem("token");fetch("/api/residents",{method:"GET",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.status==="success"?this.residents=e.data:alert("获取居民列表失败："+e.message)}).catch(e=>{console.error("获取居民列表失败：",e),alert("获取居民列表失败，请稍后重试")})},assignRepair(i,e){if(!e){alert("请选择服务商");return}const r=localStorage.getItem("token");fetch(`/api/repair/assign/${i}`,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({providerId:e})}).then(c=>c.json()).then(c=>{c.status==="success"?(alert("任务分配成功"),this.fetchRepairs()):alert("任务分配失败："+(c.message||"未知错误"))}).catch(c=>{console.error("任务分配失败：",c),alert("任务分配失败，请稍后重试")})},updateRepairStatus(i,e){if(this.role==="property_admin"&&e==="completed"){alert('您没有权限将报修单状态更新为"已完成"');return}const r=this.getLocalStorageItem("token");fetch(`/api/repair/status/${i}`,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({status:e})}).then(c=>c.json()).then(c=>{c.status==="success"?(alert("状态更新成功"),this.fetchRepairs()):alert("状态更新失败："+(c.message||"未知错误"))}).catch(c=>{console.error("状态更新失败：",c),alert("状态更新失败，请稍后重试")})},viewEvaluation(i){const e=localStorage.getItem("token");fetch(`/api/repair/detail/${i}`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}).then(r=>r.json()).then(r=>{r.status==="success"?(this.currentEvaluation=r.data.evaluation,this.showEvaluation=!0):alert("获取报修详情失败："+r.message)}).catch(r=>{console.error("获取报修详情失败：",r),alert("获取报修详情失败，请稍后重试")})},viewImage(i){this.previewImage=i},viewRepairDetail(i){const e=this.residents.find(n=>n.id===i.residentId);let r=i;e&&(r={...i,residentName:e.realName,residentPhone:e.phone,residentEmail:e.email,residentAddress:e.address}),this.currentRepair=r,this.showRepairDetail=!0;const c=localStorage.getItem("token");fetch(`/api/repair/detail/${i.id}`,{method:"GET",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{var d,R,y,k;if(n.status==="success"){const m=n.data;this.currentRepair={...m,residentName:((d=m.resident)==null?void 0:d.realName)||m.residentName||this.currentRepair.residentName,residentPhone:((R=m.resident)==null?void 0:R.phone)||m.residentPhone||this.currentRepair.residentPhone,residentEmail:((y=m.resident)==null?void 0:y.email)||m.residentEmail||this.currentRepair.residentEmail,residentAddress:((k=m.resident)==null?void 0:k.address)||m.residentAddress||this.currentRepair.residentAddress}}else console.error("获取完整报修详情失败：",n.message)}).catch(n=>{console.error("获取完整报修详情失败：",n)})},getRepairImages(i){if(!i)return[];if(!i.images)return[];const e=i.images||i.pictures||i.attachments;if(Array.isArray(e))return e.map(r=>typeof r=="object"&&r!==null?r.imageUrl||r.url||r.path||r.src||"":r).filter(r=>typeof r=="string"&&r.trim());if(typeof e=="string")try{const r=JSON.parse(e);if(Array.isArray(r))return this.getRepairImages({images:r})}catch{return[e]}if(typeof e=="object"&&e!==null){const r=e.imageUrl||e.url||e.path||e.src;return r?[r]:[]}return[]},refreshList(){this.fetchRepairs()},beforeUnmount(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)},getStatusText(i){return{pending:"待受理",processing:"处理中",completed:"已完成"}[i]||i},formatDate(i){return i?new Date(i).toLocaleString():""},handleBack(){this.$router.push("/admin")},handleProfile(){this.$router.push("/admin/profile")},handleLogout(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null),typeof localStorage<"u"&&(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("role"),localStorage.removeItem("realName"),localStorage.removeItem("phone"),localStorage.removeItem("email"),localStorage.removeItem("address"),localStorage.removeItem("idCard")),this.$router.push("/login")}}},T={class:"container"},j={class:"user-info"},L={class:"repair-management"},B={class:"search-filter"},P={class:"resident-search"},K={key:0,class:"resident-dropdown"},U=["onClick"],x={class:"resident-phone"},V=["value"],z={class:"repair-list"},F={key:0,class:"empty-state"},M={class:"repair-header"},G={class:"repair-info"},J={class:"info-section"},O={class:"info-section"},W={key:0},q={class:"repair-content"},H={key:0},Q={key:0,class:"repair-images"},X={class:"image-grid"},Y=["src","onClick"],Z={class:"repair-actions"},$=["onClick"],ee={key:0,class:"action-group"},te=["onUpdate:modelValue"],se=["value"],ne=["onClick"],re={key:1,class:"action-group"},ie=["onUpdate:modelValue"],oe=["disabled"],le=["onClick"],ae=["onClick"],de={key:0,class:"modal"},ue={class:"modal-content"},ce={class:"modal-header"},pe={class:"modal-body"},he={key:0,class:"evaluation-detail"},me={class:"rating"},ve={class:"evaluation-content"},ge={class:"evaluation-time"},fe={key:1,class:"no-evaluation-modal"},Re={key:1,class:"modal"},ye={class:"modal-content"},ke={class:"modal-header"},Ie={key:0,class:"modal-body"},_e={class:"repair-detail"},Se={class:"detail-section"},we={class:"detail-section"},be={key:0},Ce={key:1},Ae={class:"repair-images"},Ee={key:0,class:"image-grid"},De=["src","onClick"],Ne={key:1,class:"no-images"},Te={class:"detail-section"},je={key:0},Le={class:"detail-section"},Be={key:0,class:"evaluation-info"},Pe={class:"rating"},Ke={class:"evaluation-content"},Ue={class:"evaluation-time"},xe={key:1,class:"no-evaluation"},Ve={key:2,class:"modal"},ze={class:"modal-content image-preview"},Fe=["src"];function Me(i,e,r,c,n,d){var R,y,k,m;return o(),l("div",T,[t("header",null,[e[12]||(e[12]=t("h1",null,"报修管理",-1)),t("div",j,[t("span",null,"欢迎您，"+a(n.username),1),t("button",{class:"btn",onClick:e[0]||(e[0]=(...s)=>d.handleBack&&d.handleBack(...s))},"返回首页"),t("button",{class:"btn",onClick:e[1]||(e[1]=(...s)=>d.handleProfile&&d.handleProfile(...s))},"个人中心"),t("button",{class:"btn",onClick:e[2]||(e[2]=(...s)=>d.handleLogout&&d.handleLogout(...s))},"退出登录")])]),t("div",L,[t("div",B,[t("div",P,[f(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=s=>n.residentSearchKeyword=s),placeholder:"搜索居民姓名或电话",class:"search-input"},null,512),[[A,n.residentSearchKeyword]]),n.residents.length>0&&n.residentSearchKeyword?(o(),l("div",K,[(o(!0),l(v,null,g(d.filteredResidents,s=>(o(),l("div",{key:s.id,class:"resident-item",onClick:I=>d.selectResident(s)},[t("span",null,a(s.realName),1),t("span",x,a(s.phone),1)],8,U))),128))])):h("",!0)]),f(t("select",{"onUpdate:modelValue":e[4]||(e[4]=s=>n.selectedResidentId=s),class:"filter-select"},[e[13]||(e[13]=t("option",{value:""},"全部居民",-1)),(o(!0),l(v,null,g(n.residents,s=>(o(),l("option",{key:s.id,value:s.id},a(s.realName)+" ("+a(s.phone)+")",9,V))),128))],512),[[_,n.selectedResidentId]]),f(t("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=s=>n.searchKeyword=s),placeholder:"搜索报修内容或单号",class:"search-input"},null,512),[[A,n.searchKeyword]]),f(t("select",{"onUpdate:modelValue":e[6]||(e[6]=s=>n.statusFilter=s),class:"filter-select"},[...e[14]||(e[14]=[t("option",{value:""},"全部状态",-1),t("option",{value:"pending"},"待受理",-1),t("option",{value:"processing"},"处理中",-1),t("option",{value:"completed"},"已完成",-1)])],512),[[_,n.statusFilter]]),t("button",{class:"btn",onClick:e[7]||(e[7]=(...s)=>d.fetchRepairs&&d.fetchRepairs(...s))},"查询"),t("button",{class:"btn btn-primary",onClick:e[8]||(e[8]=(...s)=>d.refreshList&&d.refreshList(...s))},"刷新列表")]),t("div",z,[n.repairs.length===0?(o(),l("div",F,[...e[15]||(e[15]=[t("p",null,"暂无报修记录",-1)])])):(o(!0),l(v,{key:1},g(n.repairs,s=>{var I,w,b,C;return o(),l("div",{class:"repair-item",key:s.id},[t("div",M,[t("h3",null,"报修单号：BR"+a(String(s.id).padStart(6,"0")),1),t("span",{class:S(["status",s.status])},a(d.getStatusText(s.status)),3)]),t("div",G,[t("div",J,[t("p",null,[e[16]||(e[16]=t("strong",null,"居民：",-1)),u(a(((I=s.resident)==null?void 0:I.realName)||s.residentId),1)]),t("p",null,[e[17]||(e[17]=t("strong",null,"报修时间：",-1)),u(a(d.formatDate(s.createdAt)),1)]),t("p",null,[e[18]||(e[18]=t("strong",null,"联系电话：",-1)),u(a(((w=s.resident)==null?void 0:w.phone)||"-"),1)]),t("p",null,[e[19]||(e[19]=t("strong",null,"地址：",-1)),u(a(((b=s.resident)==null?void 0:b.address)||"未获取到地址信息"),1)])]),t("div",O,[t("p",null,[e[20]||(e[20]=t("strong",null,"服务商：",-1)),u(a(((C=s.serviceProvider)==null?void 0:C.realName)||"未分配"),1)]),s.updatedAt?(o(),l("p",W,[e[21]||(e[21]=t("strong",null,"更新时间：",-1)),u(a(d.formatDate(s.updatedAt)),1)])):h("",!0)])]),t("div",q,[s.title?(o(),l("h4",H,[e[22]||(e[22]=t("strong",null,"报修标题：",-1)),u(a(s.title),1)])):h("",!0),t("p",null,[e[23]||(e[23]=t("strong",null,"报修内容：",-1)),u(a(s.content),1)])]),d.getRepairImages(s).length>0?(o(),l("div",Q,[e[24]||(e[24]=t("strong",null,"报修图片：",-1)),t("div",X,[(o(!0),l(v,null,g(d.getRepairImages(s),(p,E)=>(o(),l("img",{key:E,src:p,class:"repair-image",onClick:Ge=>d.viewImage(p)},null,8,Y))),128))])])):h("",!0),t("div",Z,[t("button",{class:"btn btn-primary",onClick:p=>d.viewRepairDetail(s)},"查看详情",8,$),s.status==="pending"&&s.status!=="completed"?(o(),l("div",ee,[f(t("select",{"onUpdate:modelValue":p=>s.providerId=p,class:"select-provider"},[e[25]||(e[25]=t("option",{value:""},"选择服务商",-1)),(o(!0),l(v,null,g(n.providers,p=>(o(),l("option",{key:p.id,value:p.id},a(p.username),9,se))),128))],8,te),[[_,s.providerId]]),t("button",{class:"btn btn-primary",onClick:p=>d.assignRepair(s.id,s.providerId)},"分配任务",8,ne)])):h("",!0),s.status!=="completed"?(o(),l("div",re,[f(t("select",{"onUpdate:modelValue":p=>s.status=p,class:"select-status"},[e[26]||(e[26]=t("option",{value:"pending"},"待受理",-1)),e[27]||(e[27]=t("option",{value:"processing"},"处理中",-1)),t("option",{value:"completed",disabled:n.role!=="service_provider"},"已完成",8,oe)],8,ie),[[_,s.status]]),t("button",{class:"btn btn-primary",onClick:p=>d.updateRepairStatus(s.id,s.status)},"更新状态",8,le)])):h("",!0),s.status==="completed"&&s.evaluation?(o(),l("button",{key:2,class:"btn",onClick:p=>d.viewEvaluation(s.id)},"查看评价",8,ae)):h("",!0)])])}),128))])]),n.showEvaluation?(o(),l("div",de,[t("div",ue,[t("div",ce,[e[28]||(e[28]=t("h3",null,"报修评价详情",-1)),t("button",{class:"close-btn",onClick:e[9]||(e[9]=s=>n.showEvaluation=!1)},"×")]),t("div",pe,[n.currentEvaluation?(o(),l("div",he,[t("div",me,[(o(),l(v,null,g(5,s=>t("span",{key:s,class:S(["star",{filled:s<=n.currentEvaluation.rating}])},"★",2)),64))]),t("p",ve,a(n.currentEvaluation.comment),1),t("p",ge,"评价时间："+a(d.formatDate(n.currentEvaluation.createdAt)),1)])):(o(),l("div",fe," 暂无评价 "))])])])):h("",!0),n.showRepairDetail?(o(),l("div",Re,[t("div",ye,[t("div",ke,[e[29]||(e[29]=t("h3",null,"报修详情",-1)),t("button",{class:"close-btn",onClick:e[10]||(e[10]=s=>n.showRepairDetail=!1)},"×")]),n.currentRepair?(o(),l("div",Ie,[t("div",_e,[t("div",Se,[e[35]||(e[35]=t("h4",null,"居民信息",-1)),t("p",null,[e[30]||(e[30]=t("strong",null,"居民ID：",-1)),u(a(n.currentRepair.residentId),1)]),t("p",null,[e[31]||(e[31]=t("strong",null,"姓名：",-1)),u(a(((R=n.currentRepair.resident)==null?void 0:R.realName)||"未获取到姓名信息"),1)]),t("p",null,[e[32]||(e[32]=t("strong",null,"电话号码：",-1)),u(a(((y=n.currentRepair.resident)==null?void 0:y.phone)||"未获取到电话信息"),1)]),t("p",null,[e[33]||(e[33]=t("strong",null,"邮箱：",-1)),u(a(((k=n.currentRepair.resident)==null?void 0:k.email)||"未获取到邮箱信息"),1)]),t("p",null,[e[34]||(e[34]=t("strong",null,"地址：",-1)),u(a(((m=n.currentRepair.resident)==null?void 0:m.address)||"未获取到地址信息"),1)])]),t("div",we,[e[43]||(e[43]=t("h4",null,"报修信息",-1)),t("p",null,[e[36]||(e[36]=t("strong",null,"报修单号：",-1)),u("BR"+a(String(n.currentRepair.id).padStart(6,"0")),1)]),t("p",null,[e[37]||(e[37]=t("strong",null,"报修时间：",-1)),u(a(d.formatDate(n.currentRepair.createdAt)),1)]),t("p",null,[e[38]||(e[38]=t("strong",null,"报修标题：",-1)),u(a(n.currentRepair.title||"无标题"),1)]),t("p",null,[e[39]||(e[39]=t("strong",null,"报修内容：",-1)),u(a(n.currentRepair.content),1)]),n.currentRepair.resident?(o(),l("p",be,[e[40]||(e[40]=t("strong",null,"报修地址：",-1)),u(a(n.currentRepair.resident.address),1)])):h("",!0),n.currentRepair.resident?(o(),l("p",Ce,[e[41]||(e[41]=t("strong",null,"联系电话：",-1)),u(a(n.currentRepair.resident.phone),1)])):h("",!0),t("div",Ae,[e[42]||(e[42]=t("strong",null,"报修图片：",-1)),d.getRepairImages(n.currentRepair).length>0?(o(),l("div",Ee,[(o(!0),l(v,null,g(d.getRepairImages(n.currentRepair),(s,I)=>(o(),l("img",{key:I,src:s,class:"repair-image",onClick:w=>d.viewImage(s)},null,8,De))),128))])):(o(),l("div",Ne," 暂无报修图片 "))])]),t("div",Te,[e[47]||(e[47]=t("h4",null,"处理信息",-1)),t("p",null,[e[44]||(e[44]=t("strong",null,"服务商：",-1)),u(a(n.currentRepair.serviceProvider?n.currentRepair.serviceProvider.realName:"未分配"),1)]),t("p",null,[e[45]||(e[45]=t("strong",null,"当前状态：",-1)),t("span",{class:S(["status",n.currentRepair.status])},a(d.getStatusText(n.currentRepair.status)),3)]),n.currentRepair.updatedAt?(o(),l("p",je,[e[46]||(e[46]=t("strong",null,"更新时间：",-1)),u(a(d.formatDate(n.currentRepair.updatedAt)),1)])):h("",!0)]),t("div",Le,[e[48]||(e[48]=t("h4",null,"评价信息",-1)),n.currentRepair.evaluation?(o(),l("div",Be,[t("div",Pe,[(o(),l(v,null,g(5,s=>t("span",{key:s,class:S(["star",{filled:s<=n.currentRepair.evaluation.rating}])},"★",2)),64))]),t("p",Ke,a(n.currentRepair.evaluation.comment),1),t("p",Ue,"评价时间："+a(d.formatDate(n.currentRepair.evaluation.createdAt)),1)])):(o(),l("div",xe," 暂无评价 "))])])])):h("",!0)])])):h("",!0),n.previewImage?(o(),l("div",Ve,[t("div",ze,[t("button",{class:"close-btn",onClick:e[11]||(e[11]=s=>n.previewImage="")},"×"),t("img",{src:n.previewImage,alt:"图片预览"},null,8,Fe)])])):h("",!0)])}const Oe=D(N,[["render",Me],["__scopeId","data-v-dd34edd9"]]);export{Oe as default};
//# sourceMappingURL=AdminRepairManagement-e9da3587.js.map
