import{_ as R,o as i,c as o,a as t,t as c,n as g,e as b,v as y,h as w,F as v,i as f,d as k,f as d,g as m}from"./index-1ef266be.js";const _={name:"ResidentRepairs",data(){return{username:"",userData:{},activeTab:"history",repairs:[],searchKeyword:"",statusFilter:"",newRepair:{content:""},selectedImages:[],submitting:!1,showEvaluate:!1,evaluateRepairId:null,evaluateForm:{rating:5,content:""},previewImage:"",showDetail:!1,currentRepair:null,refreshInterval:null}},mounted(){this.username=this.getLocalStorageItem("username"),this.fetchUserData(),this.fetchRepairs(),this.refreshInterval=setInterval(()=>{this.fetchRepairs()},3e4)},methods:{getLocalStorageItem(l){return typeof localStorage<"u"?localStorage.getItem(l):null},setLocalStorageItem(l,e){typeof localStorage<"u"&&localStorage.setItem(l,e)},fetchUserData(){const l=this.getLocalStorageItem("userData");if(l)this.userData=JSON.parse(l);else{const e=this.getLocalStorageItem("token");fetch("/api/user",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}).then(u=>u.json()).then(u=>{(u.code==="success"||u.status==="success")&&(this.userData=u.data,this.setLocalStorageItem("userData",JSON.stringify(u.data)))}).catch(u=>{console.error("获取用户信息失败：",u)})}},fetchRepairs(){const l=this.getLocalStorageItem("token"),e=new URLSearchParams;this.searchKeyword&&e.append("searchKeyword",this.searchKeyword),this.statusFilter&&e.append("status",this.statusFilter);const u=e.toString()?`?${e.toString()}`:"";fetch(`/api/repair/list${u}`,{method:"GET",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}}).then(a=>{if(!a.ok)throw new Error("网络请求失败，状态码："+a.status);return a.json()}).then(a=>{if(a.code==="success"||a.status==="success"){if(this.repairs=a.data.filter(s=>s.status!=="withdrawn"),this.showDetail&&this.currentRepair){const s=this.currentRepair.sequentialId;this.viewRepairDetail(this.currentRepair.id,s)}}else alert("获取报修列表失败："+(a.message||"未知错误"))}).catch(a=>{console.error("获取报修列表失败：",a),alert("获取报修列表失败，请稍后重试")})},async submitRepair(){if(!this.newRepair.content.trim()){alert("请输入报修内容");return}this.submitting=!0;const l=this.getLocalStorageItem("token"),e=await this.uploadImages(),u={title:"报修请求",content:this.newRepair.content,images:e};fetch("/api/repair/submit",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify(u)}).then(a=>a.json()).then(a=>{this.submitting=!1,a.code==="success"||a.status==="success"?(alert("报修提交成功"),this.newRepair.content="",this.selectedImages=[],this.activeTab="history",this.fetchRepairs()):alert("报修提交失败："+(a.message||"未知错误"))}).catch(a=>{this.submitting=!1,console.error("报修提交失败：",a),alert("报修提交失败，请稍后重试")})},async uploadImages(){if(this.selectedImages.length===0)return[];const l=this.getLocalStorageItem("token"),e=[];for(const u of this.selectedImages){const a=new FormData;a.append("image",u.file);try{const n=await(await fetch("/api/repair/upload",{method:"POST",headers:{Authorization:`Bearer ${l}`},body:a})).json();n.code==="success"||n.status==="success"?e.push(n.data):console.error("图片上传失败：",n.message)}catch(s){console.error("图片上传失败：",s)}}return e},handleImageUpload(l){const e=l.target.files;if(e&&e.length>0){const u=3-this.selectedImages.length,a=Math.min(e.length,u),s=this;for(let n=0;n<a;n++){const r=e[n],h=new FileReader;h.onload=function(p){s.selectedImages.push({src:p.target.result,file:r})},h.readAsDataURL(r)}}},removeImage(l){this.selectedImages.splice(l,1)},showEvaluateModal(l){this.evaluateRepairId=l,this.evaluateForm={rating:5,content:""},this.showEvaluate=!0},submitEvaluation(){if(!this.evaluateForm.content.trim()){alert("请输入评价内容");return}const l=this.getLocalStorageItem("token");fetch(`/api/repair/evaluate/${this.evaluateRepairId}`,{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify(this.evaluateForm)}).then(e=>e.json()).then(e=>{e.code==="success"||e.status==="success"?(alert("评价提交成功"),this.showEvaluate=!1,this.fetchRepairs()):alert("评价提交失败："+(e.message||"未知错误"))}).catch(e=>{console.error("评价提交失败：",e),alert("评价提交失败，请稍后重试")})},viewImage(l){this.previewImage=l},viewRepairDetail(l,e){const u=this.getLocalStorageItem("token");fetch(`/api/repair/detail/${l}`,{method:"GET",headers:{Authorization:`Bearer ${u}`,"Content-Type":"application/json"}}).then(a=>a.json()).then(a=>{a.code==="success"||a.status==="success"?(this.currentRepair=a.data,this.currentRepair.sequentialId=e,this.showDetail=!0):alert("获取报修详情失败："+a.message)}).catch(a=>{console.error("获取报修详情失败：",a),alert("获取报修详情失败，请稍后重试")})},getStatusText(l){return{pending:"待受理",processing:"处理中",completed:"已完成",withdrawn:"已撤回"}[l]||l},formatDate(l){if(!l)return"";const e=new Date(l);return isNaN(e.getTime())?"":e.toLocaleString()},handleBack(){this.$router.push("/resident")},handleProfile(){this.$router.push("/resident/profile")},handleLogout(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null),typeof localStorage<"u"&&(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("role"),localStorage.removeItem("realName"),localStorage.removeItem("phone"),localStorage.removeItem("email"),localStorage.removeItem("address"),localStorage.removeItem("idCard")),this.$router.push("/login")},beforeUnmount(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)},withdrawRepair(l){if(confirm("确定要撤回报修吗？")){const e=this.getLocalStorageItem("token");fetch(`/api/repair/${l}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}).then(u=>u.json()).then(u=>{u.code==="success"||u.status==="success"?(alert("报修已成功撤回"),this.fetchRepairs()):alert("撤回报修失败："+(u.message||"未知错误"))}).catch(u=>{console.error("撤回报修失败：",u),alert("撤回报修失败，请稍后重试")})}}}},S={class:"container"},D={class:"user-info"},C={class:"repair-tabs"},T={class:"tab-content"},L={key:0,class:"history-tab"},E={class:"search-filter"},U={class:"repair-list"},A={key:0,class:"empty-state"},F=["onClick"],j={class:"repair-header"},B={class:"repair-content"},N={key:0},P={key:1},x={key:0,class:"repair-images"},z={class:"image-grid"},M=["src","onClick"],q={key:1,class:"repair-actions"},O=["onClick"],V={key:2,class:"repair-actions"},K=["onClick"],J={key:3,class:"repair-evaluation"},G={class:"rating"},H={class:"evaluation-time"},Q={key:1,class:"submit-tab"},W={class:"form-group"},X={class:"form-group"},Y={class:"image-upload-area"},Z=["src"],$=["onClick"],ee={key:0,class:"upload-btn"},te={class:"form-actions"},se=["disabled"],re={key:0,class:"modal"},ne={class:"modal-content"},ie={class:"modal-header"},oe={class:"modal-body"},le={class:"form-group"},ae={class:"rating-input"},ue=["onClick"],ce={class:"form-group"},de={class:"form-actions"},me={key:1,class:"modal"},pe={class:"modal-content image-preview"},he=["src"],ge={key:2,class:"modal"},ve={class:"modal-content"},fe={class:"modal-header"},be={class:"modal-body"},ye={class:"repair-detail"},ke={class:"detail-section"},Ie={key:0},Re={class:"detail-section"},we={key:0},_e={key:1},Se={key:2},De={class:"detail-section"},Ce={class:"detail-section"},Te={class:"image-grid"},Le=["src","onClick"],Ee={key:1,class:"no-image"},Ue={key:0,class:"detail-section"},Ae={key:0},Fe={key:1},je={key:1,class:"detail-section"},Be={class:"rating"},Ne={class:"evaluation-time"};function Pe(l,e,u,a,s,n){return i(),o("div",S,[t("header",null,[e[17]||(e[17]=t("h1",null,"我的报修",-1)),t("div",D,[t("span",null,"欢迎您，"+c(s.username),1),t("button",{class:"btn",onClick:e[0]||(e[0]=(...r)=>n.handleBack&&n.handleBack(...r))},"返回首页"),t("button",{class:"btn",onClick:e[1]||(e[1]=(...r)=>n.handleProfile&&n.handleProfile(...r))},"个人中心"),t("button",{class:"btn",onClick:e[2]||(e[2]=(...r)=>n.handleLogout&&n.handleLogout(...r))},"退出登录")])]),t("div",C,[t("button",{class:g(["tab-btn",{active:s.activeTab==="history"}]),onClick:e[3]||(e[3]=r=>s.activeTab="history")},"报修历史",2),t("button",{class:g(["tab-btn",{active:s.activeTab==="submit"}]),onClick:e[4]||(e[4]=r=>s.activeTab="submit")},"提交报修",2)]),t("div",T,[s.activeTab==="history"?(i(),o("div",L,[t("div",E,[b(t("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=r=>s.searchKeyword=r),placeholder:"搜索报修内容",class:"search-input"},null,512),[[y,s.searchKeyword]]),b(t("select",{"onUpdate:modelValue":e[6]||(e[6]=r=>s.statusFilter=r),class:"filter-select"},[...e[18]||(e[18]=[t("option",{value:""},"全部状态",-1),t("option",{value:"pending"},"待受理",-1),t("option",{value:"processing"},"处理中",-1),t("option",{value:"completed"},"已完成",-1)])],512),[[w,s.statusFilter]]),t("button",{class:"btn",onClick:e[7]||(e[7]=(...r)=>n.fetchRepairs&&n.fetchRepairs(...r))},"查询")]),t("div",U,[s.repairs.length===0?(i(),o("div",A,[...e[19]||(e[19]=[t("p",null,"暂无报修记录",-1)])])):(i(!0),o(v,{key:1},f(s.repairs,(r,h)=>(i(),o("div",{class:"repair-item",key:r.id,onClick:p=>n.viewRepairDetail(r.id,h+1)},[t("div",j,[t("h3",null,"报修单号："+c(h+1),1),t("span",{class:g(["status",r.status])},c(n.getStatusText(r.status)),3)]),t("div",B,[t("p",null,[e[20]||(e[20]=t("strong",null,"报修内容：",-1)),m(c(r.content),1)]),t("p",null,[e[21]||(e[21]=t("strong",null,"报修时间：",-1)),m(c(n.formatDate(r.createdAt)),1)]),r.serviceProvider?(i(),o("p",N,[e[22]||(e[22]=t("strong",null,"服务商：",-1)),m(c(r.serviceProvider.realName),1)])):d("",!0),r.updatedAt?(i(),o("p",P,[e[23]||(e[23]=t("strong",null,"更新时间：",-1)),m(c(n.formatDate(r.updatedAt)),1)])):d("",!0)]),r.images&&r.images.length>0?(i(),o("div",x,[e[24]||(e[24]=t("strong",null,"报修图片：",-1)),t("div",z,[(i(!0),o(v,null,f(r.images,(p,I)=>(i(),o("img",{key:I,src:p.imageUrl,class:"repair-image",onClick:xe=>n.viewImage(p.imageUrl)},null,8,M))),128))])])):d("",!0),r.status==="pending"&&r.status!=="completed"?(i(),o("div",q,[t("button",{class:"btn",onClick:p=>n.withdrawRepair(r.id)},"撤回报修",8,O)])):d("",!0),r.status==="completed"&&!r.evaluation?(i(),o("div",V,[t("button",{class:"btn btn-primary",onClick:p=>n.showEvaluateModal(r.id)},"评价报修",8,K)])):d("",!0),r.evaluation?(i(),o("div",J,[e[25]||(e[25]=t("h4",null,"我的评价",-1)),t("div",G,[(i(),o(v,null,f(5,p=>t("span",{key:p,class:g(["star",{filled:p<=r.evaluation.rating}])},"★",2)),64))]),t("p",null,c(r.evaluation.comment),1),t("p",H,c(n.formatDate(r.evaluation.createdAt)),1)])):d("",!0)],8,F))),128))])])):s.activeTab==="submit"?(i(),o("div",Q,[e[29]||(e[29]=t("h2",null,"提交报修请求",-1)),t("form",{onSubmit:e[10]||(e[10]=k((...r)=>n.submitRepair&&n.submitRepair(...r),["prevent"])),class:"repair-form"},[t("div",W,[e[26]||(e[26]=t("label",{for:"content"},"报修内容：",-1)),b(t("textarea",{id:"content","onUpdate:modelValue":e[8]||(e[8]=r=>s.newRepair.content=r),rows:"5",placeholder:"请详细描述报修问题",required:""},null,512),[[y,s.newRepair.content]])]),t("div",X,[e[28]||(e[28]=t("label",null,"上传图片（最多3张）：",-1)),t("div",Y,[(i(!0),o(v,null,f(s.selectedImages,(r,h)=>(i(),o("div",{key:h,class:"uploaded-image"},[t("img",{src:r.src,alt:"上传的图片"},null,8,Z),t("button",{type:"button",class:"remove-image",onClick:p=>n.removeImage(h)},"×",8,$)]))),128)),s.selectedImages.length<3?(i(),o("label",ee,[t("input",{type:"file",accept:"image/gif,image/jpeg,image/png,image/jpg",onChange:e[9]||(e[9]=(...r)=>n.handleImageUpload&&n.handleImageUpload(...r)),multiple:""},null,32),e[27]||(e[27]=t("span",null,"+ 上传图片",-1))])):d("",!0)])]),t("div",te,[t("button",{type:"submit",class:"btn btn-primary",disabled:s.submitting},"提交报修",8,se)])],32)])):d("",!0)]),s.showEvaluate?(i(),o("div",re,[t("div",ne,[t("div",ie,[e[30]||(e[30]=t("h3",null,"评价报修",-1)),t("button",{class:"close-btn",onClick:e[11]||(e[11]=r=>s.showEvaluate=!1)},"×")]),t("div",oe,[t("form",{onSubmit:e[14]||(e[14]=k((...r)=>n.submitEvaluation&&n.submitEvaluation(...r),["prevent"]))},[t("div",le,[e[31]||(e[31]=t("label",null,"评分：",-1)),t("div",ae,[(i(),o(v,null,f(5,r=>t("span",{key:r,class:g(["star",{filled:r<=s.evaluateForm.rating}]),onClick:h=>s.evaluateForm.rating=r},"★",10,ue)),64))])]),t("div",ce,[e[32]||(e[32]=t("label",{for:"evaluation-content"},"评价内容：",-1)),b(t("textarea",{id:"evaluation-content","onUpdate:modelValue":e[12]||(e[12]=r=>s.evaluateForm.content=r),rows:"4",placeholder:"请输入您的评价",required:""},null,512),[[y,s.evaluateForm.content]])]),t("div",de,[t("button",{type:"button",class:"btn",onClick:e[13]||(e[13]=r=>s.showEvaluate=!1)},"取消"),e[33]||(e[33]=t("button",{type:"submit",class:"btn btn-primary"},"提交评价",-1))])],32)])])])):d("",!0),s.previewImage?(i(),o("div",me,[t("div",pe,[t("button",{class:"close-btn",onClick:e[15]||(e[15]=r=>s.previewImage="")},"×"),t("img",{src:s.previewImage,alt:"图片预览"},null,8,he)])])):d("",!0),s.showDetail&&s.currentRepair?(i(),o("div",ge,[t("div",ve,[t("div",fe,[e[34]||(e[34]=t("h3",null,"报修详情",-1)),t("button",{class:"close-btn",onClick:e[16]||(e[16]=r=>s.showDetail=!1)},"×")]),t("div",be,[t("div",ye,[t("div",ke,[e[39]||(e[39]=t("h4",null,"基本信息",-1)),t("p",null,[e[35]||(e[35]=t("strong",null,"报修单号：",-1)),m(c(s.currentRepair.sequentialId||s.currentRepair.id),1)]),t("p",null,[e[36]||(e[36]=t("strong",null,"状态：",-1)),t("span",{class:g(["status",s.currentRepair.status])},c(n.getStatusText(s.currentRepair.status)),3)]),t("p",null,[e[37]||(e[37]=t("strong",null,"报修时间：",-1)),m(c(n.formatDate(s.currentRepair.createdAt)),1)]),s.currentRepair.updatedAt?(i(),o("p",Ie,[e[38]||(e[38]=t("strong",null,"更新时间：",-1)),m(c(n.formatDate(s.currentRepair.updatedAt)),1)])):d("",!0)]),t("div",Re,[e[45]||(e[45]=t("h4",null,"居民信息",-1)),t("p",null,[e[40]||(e[40]=t("strong",null,"用户名：",-1)),m(c(s.username),1)]),t("p",null,[e[41]||(e[41]=t("strong",null,"姓名：",-1)),m(c(s.userData.realName||s.username),1)]),s.userData.phone?(i(),o("p",we,[e[42]||(e[42]=t("strong",null,"手机号：",-1)),m(c(s.userData.phone),1)])):d("",!0),s.userData.address?(i(),o("p",_e,[e[43]||(e[43]=t("strong",null,"居住地址：",-1)),m(c(s.userData.address),1)])):d("",!0),s.userData.email?(i(),o("p",Se,[e[44]||(e[44]=t("strong",null,"邮箱：",-1)),m(c(s.userData.email),1)])):d("",!0)]),t("div",De,[e[46]||(e[46]=t("h4",null,"报修内容",-1)),t("p",null,c(s.currentRepair.content),1)]),t("div",Ce,[e[47]||(e[47]=t("h4",null,"报修图片",-1)),t("div",Te,[s.currentRepair.images&&s.currentRepair.images.length>0?(i(!0),o(v,{key:0},f(s.currentRepair.images,(r,h)=>(i(),o("img",{key:h,src:r.imageUrl,class:"repair-image",onClick:p=>n.viewImage(r.imageUrl)},null,8,Le))),128)):(i(),o("p",Ee,"暂无报修图片"))])]),s.currentRepair.serviceProvider?(i(),o("div",Ue,[e[51]||(e[51]=t("h4",null,"处理信息",-1)),t("p",null,[e[48]||(e[48]=t("strong",null,"服务商：",-1)),m(c(s.currentRepair.serviceProvider.realName),1)]),s.currentRepair.repairTime?(i(),o("p",Ae,[e[49]||(e[49]=t("strong",null,"处理时间：",-1)),m(c(n.formatDate(s.currentRepair.repairTime)),1)])):d("",!0),s.currentRepair.completedTime?(i(),o("p",Fe,[e[50]||(e[50]=t("strong",null,"完成时间：",-1)),m(c(n.formatDate(s.currentRepair.completedTime)),1)])):d("",!0)])):d("",!0),s.currentRepair.evaluation?(i(),o("div",je,[e[52]||(e[52]=t("h4",null,"我的评价",-1)),t("div",Be,[(i(),o(v,null,f(5,r=>t("span",{key:r,class:g(["star",{filled:r<=s.currentRepair.evaluation.rating}])},"★",2)),64))]),t("p",null,c(s.currentRepair.evaluation.comment),1),t("p",Ne,c(n.formatDate(s.currentRepair.evaluation.createdAt)),1)])):d("",!0)])])])])):d("",!0)])}const Me=R(_,[["render",Pe],["__scopeId","data-v-8ee27286"]]);export{Me as default};
//# sourceMappingURL=ResidentRepairs-0d20361d.js.map
