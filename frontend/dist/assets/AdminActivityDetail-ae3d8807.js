import{c}from"./api-5fa05d82.js";import{_ as h,o as l,c as o,a as e,t as r,n as v,e as y,h as m,f as d,F as g,i as f,v as b,d as p}from"./index-1ef266be.js";const k={name:"AdminActivityDetail",data(){return{activity:null,loading:!1,showQrCode:!1,showEvaluateModal:!1,rating:5,evaluation:"",isRegistered:!1,isPublisher:!1,selectedStatus:""}},computed:{canRegister(){if(!this.activity)return!1;const s=new Date,t=new Date(this.activity.startTime);return!this.isRegistered&&this.activity.status==="pending"&&s<t&&(!this.activity.maxParticipants||this.activity.currentParticipants<this.activity.maxParticipants)},canCancelRegister(){if(!this.activity)return!1;const s=new Date,t=new Date(this.activity.startTime);return this.isRegistered&&this.activity.status==="pending"&&s<t},canCheckin(){if(!this.activity)return!1;const s=new Date,t=new Date(this.activity.startTime),u=new Date(this.activity.endTime);return this.isRegistered&&this.activity.status==="ongoing"&&s>=t&&s<=u},canEvaluate(){if(!this.activity)return!1;const s=new Date,t=new Date(this.activity.endTime);return this.activity.status==="completed"&&s>t}},mounted(){this.fetchActivityDetail()},methods:{async fetchActivityDetail(){this.loading=!0;try{const s=this.$route.params.id,t=await c.getActivityDetail(s);t.code==="success"?(t.data.activity?(this.activity=t.data.activity,this.isRegistered=t.data.isRegistered||!1):(this.activity=t.data,this.isRegistered=!1),this.isPublisher=this.activity.userId===parseInt(localStorage.getItem("userId")),this.selectedStatus=this.activity.status):(console.error("获取活动详情失败:",t.message),alert("获取活动详情失败"))}catch(s){console.error("获取活动详情失败:",s),alert("获取活动详情失败，请稍后重试")}finally{this.loading=!1}},async handleCheckin(){try{const s=await c.checkin(this.activity.id);s.code==="success"?(alert("签到成功！"),this.fetchActivityDetail()):alert(`签到失败：${s.message}`)}catch{alert("签到失败，请稍后重试")}},async handleRegister(){try{const s=await c.registerForActivity(this.activity.id);s.code==="success"?(alert("报名成功！"),this.fetchActivityDetail()):alert(`报名失败：${s.message}`)}catch(s){console.error("报名失败:",s),alert("报名失败，请稍后重试")}},async handleCancelRegister(){try{const s=await c.cancelRegistration(this.activity.id);s.code==="success"?(alert("取消报名成功！"),this.fetchActivityDetail()):alert(`取消报名失败：${s.message}`)}catch(s){console.error("取消报名失败:",s),alert("取消报名失败，请稍后重试")}},async handleSubmitEvaluation(){if(this.rating<1||!this.evaluation.trim()){alert("请填写完整的评价信息");return}try{const s={rating:this.rating,evaluation:this.evaluation.trim()},t=await c.evaluateActivity(this.activity.id,s);t.code==="success"?(alert("评价提交成功！"),this.showEvaluateModal=!1,this.fetchActivityDetail(),this.rating=5,this.evaluation=""):alert(`评价提交失败：${t.message}`)}catch(s){console.error("评价提交失败:",s),alert("评价提交失败，请稍后重试")}},async handleUpdateStatus(){try{const s=await c.updateActivityStatus(this.activity.id,this.selectedStatus);s.code==="success"?(alert("活动状态更新成功！"),this.fetchActivityDetail()):alert(`活动状态更新失败：${s.message}`)}catch(s){console.error("活动状态更新失败:",s),alert("活动状态更新失败，请稍后重试")}},async handleGenerateQrCode(){try{const s=await c.generateCheckinQrCode(this.activity.id);s.code==="success"?(alert("签到二维码生成成功！"),this.fetchActivityDetail()):alert(`二维码生成失败：${s.message}`)}catch(s){console.error("二维码生成失败:",s),alert("二维码生成失败，请稍后重试")}},handleBack(){this.$router.push("/admin/activities")},formatDateTime(s){return s?new Date(s).toLocaleString("zh-CN"):""},getStatusText(s){return{pending:"待开始",ongoing:"进行中",completed:"已完成",cancelled:"已取消"}[s]||s}}},C={class:"container"},w={key:0,class:"loading"},D={key:1,class:"no-data"},A={key:2,class:"activity-detail"},S={class:"activity-header"},R={class:"activity-info"},T={class:"info-item"},_={class:"info-item"},E={class:"info-item"},x={class:"info-item"},M={class:"info-item"},Q={class:"activity-content"},P={key:0,class:"activity-publisher-actions"},U={class:"status-update-section"},B=["disabled"],I={class:"qr-code-section"},q={class:"activity-actions"},N={key:1,class:"modal"},V={class:"modal-content"},F={class:"modal-header"},G={class:"modal-body"},z={class:"form-group"},L={class:"rating"},j=["onClick"],H={class:"form-group"},J={class:"modal-actions"},K={class:"qr-code-container"},O=["src"];function W(s,t,u,X,i,n){return l(),o("div",C,[e("header",null,[t[16]||(t[16]=e("h1",null,"活动详情",-1)),e("button",{class:"btn",onClick:t[0]||(t[0]=(...a)=>n.handleBack&&n.handleBack(...a))},"返回活动列表")]),i.loading?(l(),o("div",w,"加载中...")):i.activity?(l(),o("div",A,[e("div",S,[e("h2",null,r(i.activity.title),1),e("span",{class:v(["activity-status",i.activity.status])},r(n.getStatusText(i.activity.status)),3)]),e("div",R,[e("div",T,[t[17]||(t[17]=e("label",null,"发布者:",-1)),e("span",null,r(i.activity.publisherName||"匿名"),1)]),e("div",_,[t[18]||(t[18]=e("label",null,"活动时间:",-1)),e("span",null,r(n.formatDateTime(i.activity.startTime))+" - "+r(n.formatDateTime(i.activity.endTime)),1)]),e("div",E,[t[19]||(t[19]=e("label",null,"活动地点:",-1)),e("span",null,r(i.activity.location),1)]),e("div",x,[t[20]||(t[20]=e("label",null,"参与人数:",-1)),e("span",null,r(i.activity.currentParticipants)+"/"+r(i.activity.maxParticipants||"无限制"),1)]),e("div",M,[t[21]||(t[21]=e("label",null,"发布时间:",-1)),e("span",null,r(n.formatDateTime(i.activity.createdAt)),1)])]),e("div",Q,[t[22]||(t[22]=e("h3",null,"活动内容",-1)),e("p",null,r(i.activity.content),1)]),i.isPublisher?(l(),o("div",P,[t[25]||(t[25]=e("h3",null,"活动管理",-1)),e("div",U,[t[24]||(t[24]=e("label",null,"更新活动状态:",-1)),y(e("select",{"onUpdate:modelValue":t[1]||(t[1]=a=>i.selectedStatus=a),class:"status-select"},[...t[23]||(t[23]=[e("option",{value:"pending"},"待开始",-1),e("option",{value:"ongoing"},"进行中",-1),e("option",{value:"completed"},"已完成",-1),e("option",{value:"cancelled"},"已取消",-1)])],512),[[m,i.selectedStatus]]),e("button",{class:"btn btn-primary",onClick:t[2]||(t[2]=(...a)=>n.handleUpdateStatus&&n.handleUpdateStatus(...a)),disabled:i.selectedStatus===i.activity.status},"更新状态",8,B)]),e("div",I,[i.activity.qrCodeUrl?(l(),o("button",{key:0,class:"btn btn-info",onClick:t[3]||(t[3]=a=>i.showQrCode=!0)},"查看签到二维码")):(l(),o("button",{key:1,class:"btn btn-primary",onClick:t[4]||(t[4]=(...a)=>n.handleGenerateQrCode&&n.handleGenerateQrCode(...a))},"生成签到二维码"))])])):d("",!0),e("div",q,[n.canRegister?(l(),o("button",{key:0,class:"btn btn-primary",onClick:t[5]||(t[5]=(...a)=>n.handleRegister&&n.handleRegister(...a))},"立即报名")):n.canCancelRegister?(l(),o("button",{key:1,class:"btn btn-danger",onClick:t[6]||(t[6]=(...a)=>n.handleCancelRegister&&n.handleCancelRegister(...a))},"取消报名")):n.canCheckin?(l(),o("button",{key:2,class:"btn btn-success",onClick:t[7]||(t[7]=(...a)=>n.handleCheckin&&n.handleCheckin(...a))},"立即签到")):n.canEvaluate?(l(),o("button",{key:3,class:"btn btn-warning",onClick:t[8]||(t[8]=a=>i.showEvaluateModal=!0)},"评价活动")):d("",!0)]),i.showEvaluateModal?(l(),o("div",N,[e("div",V,[e("div",F,[t[26]||(t[26]=e("h3",null,"评价活动",-1)),e("button",{class:"close-btn",onClick:t[9]||(t[9]=a=>i.showEvaluateModal=!1)},"×")]),e("div",G,[e("div",z,[t[27]||(t[27]=e("label",null,"评分:",-1)),e("div",L,[(l(),o(g,null,f(5,a=>e("span",{key:a,class:v(["star",{active:i.rating>=a}]),onClick:Y=>i.rating=a}," ★ ",10,j)),64))])]),e("div",H,[t[28]||(t[28]=e("label",null,"评价内容:",-1)),y(e("textarea",{"onUpdate:modelValue":t[10]||(t[10]=a=>i.evaluation=a),placeholder:"请输入您的评价...",rows:"5"},null,512),[[b,i.evaluation]])]),e("div",J,[e("button",{class:"btn btn-primary",onClick:t[11]||(t[11]=(...a)=>n.handleSubmitEvaluation&&n.handleSubmitEvaluation(...a))},"提交评价"),e("button",{class:"btn",onClick:t[12]||(t[12]=a=>i.showEvaluateModal=!1)},"取消")])])])])):d("",!0),i.showQrCode?(l(),o("div",{key:2,class:"modal-overlay",onClick:t[15]||(t[15]=a=>i.showQrCode=!1)},[e("div",{class:"modal-content",onClick:t[14]||(t[14]=p(()=>{},["stop"]))},[t[29]||(t[29]=e("h3",null,"活动签到二维码",-1)),e("div",K,[e("img",{src:i.activity.qrCodeUrl,alt:"签到二维码"},null,8,O)]),t[30]||(t[30]=e("p",null,"请让参与者扫描此二维码进行签到",-1)),e("button",{class:"btn",onClick:t[13]||(t[13]=a=>i.showQrCode=!1)},"关闭")])])):d("",!0)])):(l(),o("div",D,"活动不存在"))])}const tt=h(k,[["render",W],["__scopeId","data-v-48e65c92"]]);export{tt as default};
//# sourceMappingURL=AdminActivityDetail-ae3d8807.js.map
